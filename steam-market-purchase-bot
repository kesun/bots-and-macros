// MODIFY THIS AREA ONLY
var desiredPrice = 0.14;
var desiredPurchaseCount = 1;
// END OF MODIFICATION AREA

var purchased = 0;

var windowID = window.open(document.URL, "_blank", "width=500, height=300");

checkReady();

function refresh(){
	//console.log("refresh");
	windowID.location.reload();
	isRefreshing = true;
	if(purchased < desiredPurchaseCount){
		setTimeout(checkReady, 500);
	}
}

function checkReady(){
	//console.log("checkReady");
	var priceListLen = windowID.document.getElementsByClassName('market_listing_their_price').length;
	var listingsLen = windowID.document.getElementsByClassName('market_content_block').length;
	if(windowID.document.getElementsByTagName('zzzzz').length == 0 && listingsLen > 0 && windowID.document.getElementsByClassName('market_listing_table_message').length == 0 && priceListLen > 1){
		checkPrice();
	}else{
		if(listingsLen == 0){
			setTimeout(refresh, 500);
		}else{
			setTimeout(checkReady, 100);
		}
	}
}

function checkPrice(){
	//console.log("checkPrice");
    windowID.document.getElementsByTagName("html")[0].appendChild(windowID.document.createElement("zzzzz"));
	var curPrice = parseFloat(windowID.document.getElementsByClassName('market_listing_their_price')[1].getElementsByClassName("market_listing_price_with_fee")[0].innerHTML.replace(/\s/g, '').substr(4));
	console.log("curPrice: " + curPrice);
	if(curPrice <= desiredPrice){
		setTimeout(function(){
			windowID.document.getElementsByClassName('item_market_action_button_contents')[0].click();
			windowID.document.getElementById('market_buynow_dialog_accept_ssa').click();
			if(windowID.document.getElementById('market_buynow_dialog_purchase').getAttribute("style") != "display: none;"){
				windowID.document.getElementById('market_buynow_dialog_purchase').getElementsByTagName("span")[0].click();
				checkTransactionState();
			}else{
				console.log("Cannot purchase, check for your balance and whatnot pl0x, then run this script again.");
			}
		}, 100);
	}else{
		refresh();
	}
}

function checkTransactionState(){
	if(windowID.document.getElementById('market_buynow_dialog_purchase').innerHTML != ""){ // purchase button visible
		if(windowID.document.getElementById('market_buynow_dialog_error_text').innerHTML != ""){ // error message visible
			refresh();
		}else{ // no error message
			setTimeout(checkTransactionState, 500);
		}
	}else{ // purchase button not visible
		if(windowID.document.getElementById('market_buynow_dialog_purchasecomplete_message').getAttribute('style') == "overflow: visible;"){ // successful purchase
			console.log("Successful purchase!");
			purchased++;
		}
		refresh();
	}
}
